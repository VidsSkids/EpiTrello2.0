<mat-toolbar class="header" role="navigation">
  <div class="toolbar-title-container">
    <mat-icon matListItemIcon>view_kanban</mat-icon>
    <a matButton class="toolbar-title" (click)="goHome()">EpiTrello</a>
  </div>
  <div class="toolbar-profile-container">
    <button matButton class="toolbar-profile" [matMenuTriggerFor]="userMenu">
      <mat-icon>account_circle</mat-icon>
    </button>
    <mat-menu #userMenu="matMenu">
      <button mat-menu-item [matMenuTriggerFor]="membersMenu">
        <mat-icon>group</mat-icon>
        <span>Members</span>
      </button>
      <button mat-menu-item (click)="leaveOrDelete()">
        <mat-icon>{{ isOwner ? 'delete' : 'logout' }}</mat-icon>
        <span>{{ isOwner ? 'Delete project' : 'Leave project' }}</span>
      </button>
    </mat-menu>
  </div>
</mat-toolbar>

@if (currentBoard$ | async; as currentBoard) {
<mat-toolbar class="board-toolbar">
  <div class="board-left">
    @if (!editingTitle) {
      <button mat-button class="board-title" (click)="startEditTitle(currentBoard)">
        <mat-icon>title</mat-icon>
        <span>{{ currentBoard.title }}</span>
      </button>
    } @else {
      <mat-form-field appearance="outline" style="min-width: 240px;">
        <mat-label>Board title</mat-label>
        <input matInput [(ngModel)]="tempTitle" (keyup.enter)="saveTitle(currentBoard)" (blur)="saveTitle(currentBoard)">
      </mat-form-field>
    }
    <button mat-stroked-button [matMenuTriggerFor]="viewsMenu">
      <mat-icon>view_agenda</mat-icon>
      Views
    </button>
    <mat-menu #viewsMenu="matMenu">
      <button mat-menu-item (click)="currentView = 'kanban'"><mat-icon>view_kanban</mat-icon> Kanban</button>
      <button mat-menu-item (click)="currentView = 'calendar'"><mat-icon>calendar_month</mat-icon> Calendar</button>
      <button mat-menu-item (click)="currentView = 'timeline'"><mat-icon>timeline</mat-icon> Timeline</button>
    </mat-menu>
  </div>
  <div class="board-right">
    <button mat-icon-button (click)="toggleFavorite(currentBoard)" [attr.aria-label]="favorite ? 'Unfavorite' : 'Favorite'">
      <mat-icon>{{ favorite ? 'star' : 'star_border' }}</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="membersMenu" aria-label="Members">
      <mat-icon>group</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="visibilityMenu">
      <mat-icon>person</mat-icon>
    </button>
    <mat-menu #visibilityMenu="matMenu">
      <button mat-menu-item (click)="setVisibility('private')">
        <mat-icon [style.visibility]="(visibility | lowercase) === 'private' ? 'visible' : 'hidden'">check</mat-icon>
        <div class="vis-menu-item">
          <span class="vis-title">Private</span>
          <span class="vis-desc">Only board members can see and edit this board.</span>
        </div>
      </button>
      <button mat-menu-item (click)="setVisibility('workspace')">
        <mat-icon [style.visibility]="(visibility | lowercase) === 'workspace' ? 'visible' : 'hidden'">check</mat-icon>
        <div class="vis-menu-item">
          <span class="vis-title">Workspace</span>
          <span class="vis-desc">All members of the Workspace can see and edit this board.</span>
        </div>
      </button>
      <button mat-menu-item (click)="setVisibility('public')">
        <mat-icon [style.visibility]="(visibility | lowercase) === 'public' ? 'visible' : 'hidden'">check</mat-icon>
        <div class="vis-menu-item">
          <span class="vis-title">Public</span>
          <span class="vis-desc">Anyone on the internet can see this board. Only board members can edit.</span>
        </div>
      </button>
    </mat-menu>
    <button mat-raised-button color="primary" (click)="openShareDialog(shareDialog)">
      <mat-icon>share</mat-icon>
      Share
    </button>
  </div>
</mat-toolbar>
}

<div class="board-container">
  
  @if (currentBoard$ | async; as currentBoard) {
    <div class="board-content">
      @if (lists$ | async; as lists) {
        <div class="lists-container" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="onListDrop($event)" [cdkDropListData]="lists">
          @for (list of lists; track list.id) {
            <app-list 
              [list]="list" 
              [allLists]="lists"
              [allTags]="(projectTags$ | async) || []"
              (listUpdated)="refreshProject()"
              cdkDrag
              class="list-item">
            </app-list>
          }
          

            @if (!showNewListForm) {
              <div class="add-list-container">
                <div mat-button (click)="showNewListForm = true" class="add-list-button">
                  <mat-icon>add</mat-icon> Add another list
                </div>
              </div>
            } @else {
              <div class="add-list-container-expanded">
                <div class="new-list-form">
                  <mat-form-field appearance="outline">
                    <mat-label>List title</mat-label>
                    <input matInput [(ngModel)]="newListTitle" placeholder="Enter list title" required (keyup.enter)="createList()">
                  </mat-form-field>
                  <div class="form-actions">
                    <button mat-raised-button color="primary" (click)="createList()" [disabled]="!newListTitle">Add List</button>
                    <button mat-icon-button (click)="showNewListForm = false">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            }

        </div>
      }
    </div>
  }
  
  @if (!(currentBoard$ | async) && ((boards$ | async)?.length === 0)) {
    <div class="empty-state">
      <h2>Welcome to EpiTrello!</h2>
      <p>Create your first board to get started.</p>
      <button mat-raised-button color="primary" (click)="showNewBoardForm = true">
        <mat-icon>add</mat-icon> Create Board
      </button>
    </div>
  }
</div>

<ng-template #shareDialog>
  <div class="share-dialog">
    <h3>Partager ce projet</h3>
    <div class="share-row">
      <mat-form-field appearance="outline" style="flex: 1;">
        <mat-label>Nom</mat-label>
        <input matInput #inviteName placeholder="Ex: Jean Dupont">
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="sendInvite(inviteName.value)">
        <mat-icon>send</mat-icon>
        Envoyer
      </button>
    </div>
    @if (inviteError) { <div class="error">{{ inviteError }}</div> }
    <div class="share-section">
      <h4>Membres</h4>
      @if ((members.length || 0) === 0) {
        <div class="members-empty">Aucun membre</div>
      } @else {
        <div class="members-list">
          @for (m of members; track m.userId) {
            <div class="member-item">
              <mat-icon>person</mat-icon>
              <div class="member-info">
                <div class="member-name">
                  {{ m.username }} 
                  @if (ownerId && (m.id === ownerId)) { <strong>(Owner)</strong> }
                </div>
              </div>
              <div style="flex: 1;"></div>
              
              @if (!ownerId || (m.id !== ownerId)) {
                <button mat-icon-button [matMenuTriggerFor]="roleMenu" [matMenuTriggerData]="{member: m}">
                  <mat-icon>{{ (m.role === 'Administrator' || m.role === 'Owner') ? 'admin_panel_settings' : (m.role === 'Contributer' ? 'edit' : 'visibility') }}</mat-icon>
                </button>
              } @else {
                <mat-icon>{{ (m.role === 'Owner') ? 'admin_panel_settings' : 'person' }}</mat-icon>
              }

              @if (canRemove(m)) {
                <button mat-icon-button color="warn" (click)="removeMember(m)">
                  <mat-icon>person_remove</mat-icon>
                </button>
              }
            </div>
          }
        </div>
      }
    </div>
    <div class="share-section">
      <h4>Invitations</h4>
      @if ((invitations.length || 0) === 0) {
        <div class="members-empty">Aucune invitation</div>
      } @else {
        <div class="members-list">
          @for (inv of invitations; track inv.id) {
            <div class="member-item">
              <mat-icon>mail</mat-icon>
              <div class="member-info">
                <div class="member-name">{{ inv.name || inv.email || inv.userId || inv.id }}</div>
                <div class="member-sub">{{ inv.createdAt | date:'short' }}</div>
              </div>
              <div style="flex: 1;"></div>
              <button mat-button color="warn" (click)="revokeInvitation(inv)">Revoke</button>
            </div>
          }
        </div>
      }
     </div>
   </div>
</ng-template>

<mat-menu #roleMenu="matMenu" yPosition="below" xPosition="after" overlapTrigger="false">
  <ng-template matMenuContent let-m="member">
    <button mat-menu-item (click)="changeMemberRole(m, 'Reader')">
      <mat-icon [style.visibility]="m.role === 'Reader' ? 'visible' : 'hidden'">check</mat-icon>
      <div class="vis-menu-item">
        <span class="vis-title">Reader</span>
        <span class="vis-desc">Can only view the board.</span>
      </div>
    </button>
    <button mat-menu-item (click)="changeMemberRole(m, 'Contributer')">
      <mat-icon [style.visibility]="m.role === 'Contributer' ? 'visible' : 'hidden'">check</mat-icon>
      <div class="vis-menu-item">
        <span class="vis-title">Contributer</span>
        <span class="vis-desc">Can view and edit the board.</span>
      </div>
    </button>
    <button mat-menu-item (click)="changeMemberRole(m, 'Administrator')">
      <mat-icon [style.visibility]="m.role === 'Administrator' ? 'visible' : 'hidden'">check</mat-icon>
      <div class="vis-menu-item">
        <span class="vis-title">Administrator</span>
        <span class="vis-desc">Can view, edit, and manage members.</span>
      </div>
    </button>
  </ng-template>
</mat-menu>

<mat-menu #membersMenu="matMenu" yPosition="below" xPosition="after" overlapTrigger="false" (opened)="onMembersMenuOpened()">
  <div class="members-menu">
    <div class="members-header">
      <mat-icon>group</mat-icon>
      <span style="margin-left: 8px;">Project members</span>
    </div>
    <div class="members-list">
      @if ((members.length || 0) === 0) {
        <div class="members-empty">No members</div>
      } @else {
        @for (m of members; track m.userId) {
          <div class="member-item">
            <mat-icon>person</mat-icon>
            <div class="member-info">
              <div class="member-name">
                {{ m.username}}
                @if (ownerId && ((m.userId || m.id) === ownerId)) { <strong>(Owner)</strong> }
              </div>
            </div>
            <div style="flex: 1;"></div>
            @if (!ownerId || ((m.userId || m.id) !== ownerId)) {
              <button mat-icon-button [matMenuTriggerFor]="roleMenu" [matMenuTriggerData]="$any({member: m})">
                <mat-icon>{{ (m.role === 'Administrator' || m.role === 'Owner') ? 'admin_panel_settings' : (m.role === 'Contributer' ? 'edit' : 'visibility') }}</mat-icon>
              </button>
            } @else {
              <mat-icon>{{ (m.role === 'Owner') ? 'admin_panel_settings' : 'person' }}</mat-icon>
            }
            @if (canRemove(m)) {
              <button mat-icon-button color="warn" (click)="removeMember(m)">
                <mat-icon>person_remove</mat-icon>
              </button>
            }
          </div>
        }
      }
    </div>
  </div>
</mat-menu>
