<div class="card-container">
  <mat-card (click)="startEdit()">
    <mat-card-content>
      <div class="card-labels">
        @for (label of cardLabels; track label.id) {
          <div class="card-label" [style.backgroundColor]="label.color"></div>
        }
      </div>
      <div class="card-title">{{ card.title }}</div>
      @if (card.description) {
        <div class="card-description">{{ card.description }}</div>
      }
    </mat-card-content>
  </mat-card>
</div>

<ng-template #editDialog>
  <h2 mat-dialog-title>Edit Card</h2>
  <div mat-dialog-content class="card-editor">
    <div class="editor-left">
      @if (!editingTitle) {
        <div class="card-title editable" (click)="toggleTitleEdit(true)">
          {{ editedTitle }}
        </div>
      }
      @if (editingTitle) {
        <div class="card-title-edit">
           <input
              #titleInput
              type="text"
              [(ngModel)]="editedTitle"
              (blur)="toggleTitleEdit(false); saveTitleInline()"
              (keyup.enter)="saveTitleInline()">
        </div>
      }

      <mat-form-field appearance="outline">
        <mat-label>Description</mat-label>
        <textarea matInput [(ngModel)]="editedDescription" (blur)="saveDescriptionInline()" placeholder="Enter description (optional)"></textarea>
      </mat-form-field>
      
      @for (cl of checklists; track cl.id) {
        <div class="checklist-block">
          <div class="checklist-header">
            <mat-icon color="primary">check_box</mat-icon>
            <input class="checklist-title-input" type="text" [(ngModel)]="cl.title" (blur)="updateChecklistTitle(cl)" (keyup.enter)="updateChecklistTitle(cl)">
            <button mat-stroked-button color="warn" class="checklist-delete" (click)="deleteChecklist(cl)">Delete</button>
          </div>
          <div class="checklist-progress-row">
            <div class="checklist-progress-text">{{ getChecklistCompletion(cl) }}%</div>
            <mat-progress-bar mode="determinate" [value]="getChecklistCompletion(cl)"></mat-progress-bar>
          </div>
          <div class="checklist-items">
            @for (it of cl.items; track (it.id || $index)) {
              <div class="checklist-item-row" (mouseenter)="it._hover = true" (mouseleave)="it._hover = false">
                <mat-checkbox [checked]="it.isDone" (change)="toggleChecklistItem(cl, it, $event.checked)"></mat-checkbox>
                <input class="checklist-item-title-input" type="text" [(ngModel)]="it.content" (blur)="updateChecklistItem(cl, it)" (keyup.enter)="updateChecklistItem(cl, it)">
                @if (it._hover) {
                  <button mat-icon-button color="warn" (click)="deleteChecklistItem(cl, it)" aria-label="Delete item">
                    <mat-icon>delete</mat-icon>
                  </button>
                }
              </div>
            }
            @if (!cl.showAddItem) {
              <button mat-stroked-button (click)="cl.showAddItem = true">Ajouter un élément</button>
            }
            @if (cl.showAddItem) {
              <div class="checklist-add-item">
                <input
                  #newItemInput
                  class="checklist-new-item-input"
                  type="text"
                  placeholder="Ajouter un élément"
                  [(ngModel)]="cl.newChecklistItemContent"
                  (keyup.enter)="addChecklistItem(cl); cl.showAddItem = false">
                <div class="form-buttons">
                  <button mat-stroked-button color="primary" (click)="addChecklistItem(cl); cl.showAddItem = false">Ajouter</button>
                  <button mat-stroked-button (click)="cl.showAddItem = false">Annuler</button>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>

    <div class="editor-right">
      <button class="editor-action-button" type="button" [matMenuTriggerFor]="labelsMenu" #labelsTrigger="matMenuTrigger" (click)="loadProjectTags()">
        <mat-icon>label</mat-icon>
        <span>Labels</span>
      </button>
      <button class="editor-action-button" type="button" [matMenuTriggerFor]="checklistMenu">
        <mat-icon>checklist</mat-icon>
        <span>Checklist</span>
      </button>

      <mat-menu #labelsMenu="matMenu" hasBackdrop class="no-scroll-menu">
        <div class="labels-menu" [ngClass]="labelsDensity" (click)="$event.stopPropagation()">
          <div class="labels-menu-header">
            <div class="labels-menu-title">Tags</div>
          </div>

          <div class="labels-section-title">tags</div>
          <div class="labels-list">
            @for (tag of tags; track tag.id) {
              <div class="label-item">
                <mat-checkbox [checked]="tag.attached" (change)="toggleTagAttachment(tag, $event.checked)"></mat-checkbox>
                <div class="label-pill" [style.background]="tag.color || '#e0e0e0'" [style.color]="getContrastingTextColor(tag.color)">
                  {{ tag.name }}
                </div>
                <button mat-icon-button (click)="editTag(tag)" aria-label="Edit label">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteTag(tag)" aria-label="Delete label">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            }
          </div>

          <div class="labels-actions">
            <button mat-stroked-button color="primary" (click)="showCreateTagForm = true; $event.stopPropagation()">Créer un label</button>
          </div>

          @if (showCreateTagForm) {
            <div class="create-tag-form">
              <input type="text" [(ngModel)]="newTagName" placeholder="Nom du label">
              <input type="color" [(ngModel)]="newTagColor">
              <div class="form-buttons">
                <button mat-stroked-button color="primary" (click)="createTag(); $event.stopPropagation()">Ajouter</button>
                <button mat-stroked-button (click)="showCreateTagForm = false; $event.stopPropagation()">Annuler</button>
              </div>
            </div>
          }
        </div>
      </mat-menu>
      
      <mat-menu #checklistMenu="matMenu" hasBackdrop class="no-scroll-menu">
        <div class="checklist-menu" (click)="$event.stopPropagation()">
          <div class="checklist-menu-header">Add checklist</div>
          <div class="checklist-menu-body">
            <input type="text" [(ngModel)]="newChecklistTitle" placeholder="Title">
            <button mat-stroked-button color="primary" (click)="addChecklist(); $event.stopPropagation()">Add</button>
          </div>
        </div>
      </mat-menu>
    </div>
  </div>
  <div mat-dialog-actions align="end">
    <button mat-button mat-dialog-close="cancel" (click)="cancelEdit()">Cancel</button>
    <button mat-icon-button color="warn" class="delete-button" mat-dialog-close="delete" aria-label="Delete">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</ng-template>
